name: Deploy Python App to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Generate SSH Key Pair
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
          chmod 600 ~/.ssh/id_rsa
          cat ~/.ssh/id_rsa.pub
        shell: bash

      - name: Upload SSH Key as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh-key
          path: ~/.ssh/id_rsa

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: >
            {
              "clientId":"${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId":"${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            }

      - name: Ensure Resource Group Exists
        run: az group create --name demo-rg --location eastus --output none || true

      - name: Ensure Virtual Machine Exists
        run: |
          if ! az vm show --resource-group demo-rg --name demo-vm --query 'name' --output tsv; then
            az vm create \
              --resource-group demo-rg \
              --name demo-vm \
              --image Ubuntu2204 \
              --admin-username azureuser \
              --public-ip-sku Standard \
              --size Standard_B2s \
              --output none
          fi

      - name: Get VM Public IP
        run: |
          ip=$(az vm list-ip-addresses \
            --resource-group demo-rg \
            --name demo-vm \
            --query "[].virtualMachine.network.publicIpAddresses[0].ipAddress" \
            --output tsv)
          echo "VM Public IP: $ip"
          echo "ip=$ip" >> $GITHUB_ENV

      - name: Download SSH Key from Artifact
        uses: actions/download-artifact@v4
        with:
          name: ssh-key
          path: ~/.ssh

      - name: Set Correct Permissions for SSH Key
        run: chmod 600 ~/.ssh/id_rsa

      - name: Manually Add SSH Public Key to VM
        run: |
          PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)
          az vm run-command invoke \
            --resource-group demo-rg \
            --name demo-vm \
            --command-id RunShellScript \
            --scripts "mkdir -p /home/azureuser/.ssh && echo \"$PUBLIC_KEY\" >> /home/azureuser/.ssh/authorized_keys && chmod 600 /home/azureuser/.ssh/authorized_keys && chown azureuser:azureuser /home/azureuser/.ssh/authorized_keys"

      - name: Verify SSH Connection
        run: ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa azureuser@${{ env.ip }} "echo SSH Connection Successful"

      - name: Install Dependencies and Deploy App
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa azureuser@${{ env.ip }} << 'EOF'
            set -e

            echo "ðŸ”¹ Updating system & installing dependencies..."
            sudo apt update
            sudo apt install -y python3 python3-pip python3-venv git

            echo "ðŸ”¹ Ensuring app directory exists..."
            mkdir -p ~/app
            cd ~/app

            echo "ðŸ”¹ Checking if repository exists..."
            if [ ! -d .git ]; then
              echo "ðŸš€ First-time setup: Cloning repository..."
              git clone https://${{ secrets.TOKEN_GITHUB }}@github.com/Ayeesha208/Python-Webapp.git .
            else
              echo "ðŸ”„ Repository exists: Pulling latest changes..."
              git pull origin main
            fi

            echo "ðŸ”¹ Listing repo contents..."
            ls -lah

            echo "ðŸ”¹ Checking for requirements.txt..."
            if [ ! -f requirements.txt ]; then
              echo "âŒ ERROR: requirements.txt not found in ~/app!"
              exit 1
            fi

            echo "âœ… Installing dependencies..."
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "ðŸ”¹ Killing existing Gunicorn processes (if any)..."
            sudo pkill -f gunicorn || true

            echo "ðŸ”¹ Ensuring port 8000 is open..."
            sudo ufw allow 8000 || true

            echo "ðŸš€ Starting application with Gunicorn..."
            nohup gunicorn --workers 3 --bind 0.0.0.0:8000 app:app &

            echo "ðŸ”„ Restarting systemd service (if configured)..."
            sudo systemctl restart myapp.service || true

            echo "âœ… Deployment completed successfully!"
          EOF
